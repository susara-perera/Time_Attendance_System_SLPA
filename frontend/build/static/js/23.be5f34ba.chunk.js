"use strict";(self.webpackChunktime_attendance_frontend=self.webpackChunktime_attendance_frontend||[]).push([[23],{23:(e,a,s)=>{s.r(a),s.d(a,{default:()=>i});var t=s(43),n=s(213),l=s(83),d=s(579);const i=()=>{const[e,a]=(0,t.useState)([]),[s,i]=(0,t.useState)(!0),[r,c]=(0,t.useState)({}),[o,m]=(0,t.useState)({}),[h,u]=(0,t.useState)(null),[x,p]=(0,t.useState)(!1),[_,j]=(0,t.useState)(null),[v,b]=(0,t.useState)({startDate:new Date(Date.now()-2592e6).toISOString().split("T")[0],endDate:(new Date).toISOString().split("T")[0]}),[y,g]=(0,t.useState)({}),k="http://10.70.4.186:5000/api";(0,t.useEffect)(()=>{N(),g({attendance_cache:{startDate:new Date(Date.now()-2592e6).toISOString().split("T")[0],endDate:(new Date).toISOString().split("T")[0]}})},[]);const N=async()=>{try{const e=localStorage.getItem("token"),s=await n.A.get(`${k}/sync-schedule`,{headers:{Authorization:`Bearer ${e}`}});s.data.success&&a(s.data.data)}catch(e){console.error("Error fetching schedules:",e),a([{task_id:"divisions_sync",task_name:"Divisions Sync",description:"Sync company divisions from HRIS",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"},{task_id:"sections_sync",task_name:"Sections Sync",description:"Sync organizational sections from HRIS",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"},{task_id:"employees_sync",task_name:"Employees Sync",description:"Sync employee records from HRIS",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"},{task_id:"dashboard_sync",task_name:"Dashboard Totals Sync",description:"Sync dashboard with latest data",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"},{task_id:"attendance_cache",task_name:"Attendance Table Cache",description:"Cache attendance data",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"},{task_id:"employees_cache",task_name:"Employees Cache",description:"Preload employees cache",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"},{task_id:"divisions_cache",task_name:"Divisions Cache",description:"Preload divisions cache",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"},{task_id:"sections_cache",task_name:"Sections Cache",description:"Preload sections cache",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"},{task_id:"subsections_cache",task_name:"Sub-Sections Cache",description:"Preload sub-sections cache",mode:"manual",repeat_interval:"none",repeat_enabled:!1,last_run:null,status:"idle"}]),u({type:"warning",text:"Could not load schedules from server, showing defaults."})}finally{i(!1)}},[f,S]=(0,t.useState)({}),w=async(s,t)=>{const l=e.find(e=>e.task_id===s);if(!l)return void u({type:"error",text:"Schedule not found"});const d={...l},i={...l,...t};console.debug("[ManualSync] Updating schedule",s,"updates=",t,"optimistic=",i),a(e=>e.map(e=>e.task_id===s?i:e)),S(e=>({...e,[s]:!0}));try{const e=localStorage.getItem("token"),t={task_id:i.task_id,task_name:i.task_name,description:i.description,mode:i.mode,schedule_date:i.schedule_date,schedule_time:i.schedule_time,date_range_start:i.date_range_start,date_range_end:i.date_range_end,repeat_interval:i.repeat_interval||"none",repeat_enabled:i.repeat_enabled||!1,last_run:i.last_run||null,status:i.status||void 0};console.debug("[ManualSync] PUT payload",t);const l=await n.A.put(`${k}/sync-schedule/${s}`,t,{headers:{Authorization:`Bearer ${e}`}});if(console.debug("[ManualSync] PUT response",null===l||void 0===l?void 0:l.data),!l.data||!l.data.success){var r;const e=(null===(r=l.data)||void 0===r?void 0:r.message)||"Unknown server response";throw new Error(e)}a(e=>e.map(e=>e.task_id===s?{...e,...l.data.data}:e)),u({type:"success",text:"Schedule updated successfully"}),setTimeout(()=>u(null),3e3)}catch(h){var c,o,m;console.error("[ManualSync] Error updating schedule:",h);const e=(null===(c=h.response)||void 0===c||null===(o=c.data)||void 0===o?void 0:o.message)||h.message||"Failed to update schedule";u({type:"error",text:e}),a(e=>e.map(e=>e.task_id===s?d:e)),401===(null===(m=h.response)||void 0===m?void 0:m.status)&&u({type:"error",text:"Authentication error. Please login again."}),console.debug("[ManualSync] Reverted schedule to previous state")}finally{S(e=>({...e,[s]:!1}))}},D=async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};c(a=>({...a,[e.task_id]:!0})),m(a=>({...a,[e.task_id]:0})),u({type:"info",text:`Starting ${e.task_name}...`});const s=setInterval(()=>{m(a=>{const s=a[e.task_id]||0;return s<90?{...a,[e.task_id]:s+10}:a})},300);try{let t="";switch(e.task_id){case"divisions_sync":t="/sync/trigger/divisions";break;case"sections_sync":t="/sync/trigger/sections";break;case"employees_sync":t="/sync/trigger/employees";break;case"dashboard_sync":t="/dashboard/total-counts/refresh";break;case"attendance_cache":t="/cache/warmup";break;case"employees_cache":t="/hris-cache/employees/refresh";break;case"divisions_cache":t="/hris-cache/divisions/refresh";break;case"sections_cache":t="/hris-cache/sections/refresh";break;case"subsections_cache":t="/hris-cache/subsections/refresh"}if(t){const l=localStorage.getItem("token");let d=`${k}${t}`;"attendance_cache"===e.task_id&&a.startDate&&a.endDate&&(d+=`?startDate=${a.startDate}&endDate=${a.endDate}`);const i=await n.A.post(d,{},{headers:{Authorization:`Bearer ${l}`}});clearInterval(s),m(a=>({...a,[e.task_id]:100})),j({taskName:e.task_name,taskId:e.task_id,data:i.data}),p(!0),u({type:"success",text:`${e.task_name} completed successfully`})}else clearInterval(s),u({type:"error",text:"No endpoint defined for this task"});w(e.task_id,{last_run:new Date,status:"completed"})}catch(d){var t,l;clearInterval(s),console.error("Error starting sync:",d),u({type:"error",text:`Failed to start ${e.task_name}: ${(null===(t=d.response)||void 0===t||null===(l=t.data)||void 0===l?void 0:l.message)||d.message}`}),m(a=>({...a,[e.task_id]:0}))}finally{setTimeout(()=>{c(a=>({...a,[e.task_id]:!1})),m(a=>({...a,[e.task_id]:0}))},2e3)}};return(0,d.jsxs)("div",{className:"manual-sync-container",children:[(0,d.jsx)(l.A,{title:"Manual Sync & Cache Management",subtitle:"Manage synchronization schedules and manual triggers",icon:"bi-arrow-repeat"}),h&&(0,d.jsx)("div",{className:`alert alert-${"error"===h.type?"danger":"success"===h.type?"success":"info"} mb-3`,children:h.text}),(0,d.jsx)("div",{className:"card shadow-sm",children:(0,d.jsx)("div",{className:"card-body p-0",children:(0,d.jsx)("div",{className:"table-responsive",children:(0,d.jsxs)("table",{className:"table table-hover align-middle mb-0",children:[(0,d.jsx)("thead",{className:"bg-light",children:(0,d.jsxs)("tr",{children:[(0,d.jsx)("th",{style:{width:"12%"},children:"Name"}),(0,d.jsx)("th",{style:{width:"12%"},children:"Description"}),(0,d.jsx)("th",{style:{width:"10%"},children:"Last Run"}),(0,d.jsx)("th",{style:{width:"8%"},children:"Progress"}),(0,d.jsx)("th",{style:{width:"8%"},children:"Action"}),(0,d.jsx)("th",{style:{width:"8%"},children:"Mode"}),(0,d.jsx)("th",{style:{width:"10%"},children:"Repeat Interval"}),(0,d.jsx)("th",{style:{width:"16%"},children:"Cache Date Range"}),(0,d.jsx)("th",{style:{width:"16%"},children:"Schedule"})]})}),(0,d.jsx)("tbody",{children:s?(0,d.jsx)("tr",{children:(0,d.jsx)("td",{colSpan:"9",className:"text-center p-4",children:"Loading schedules..."})}):e.map(e=>{var a,s;return(0,d.jsxs)("tr",{children:[(0,d.jsxs)("td",{className:"fw-bold",children:[e.task_name,e.last_run&&(0,d.jsxs)("div",{className:"text-muted small fw-normal",children:["Last: ",new Date(e.last_run).toLocaleString()]})]}),(0,d.jsx)("td",{className:"text-muted small",children:e.description}),(0,d.jsx)("td",{className:"text-muted small",children:e.last_run?new Date(e.last_run).toLocaleString():"Never"}),(0,d.jsx)("td",{children:r[e.task_id]?(0,d.jsx)("div",{children:(0,d.jsx)("div",{className:"progress",style:{height:"20px"},children:(0,d.jsxs)("div",{className:"progress-bar progress-bar-striped progress-bar-animated bg-primary",role:"progressbar",style:{width:`${o[e.task_id]||0}%`},"aria-valuenow":o[e.task_id]||0,"aria-valuemin":"0","aria-valuemax":"100",children:[o[e.task_id]||0,"%"]})})}):(0,d.jsx)("span",{className:"text-muted small",children:"Ready"})}),(0,d.jsx)("td",{children:(0,d.jsx)("div",{className:"d-flex gap-1 flex-column",children:(0,d.jsxs)("button",{className:"btn btn-sm btn-primary",onClick:()=>(async e=>{if(!r[e.task_id])if("attendance_cache"===e.task_id){const a=y[e.task_id]||v;await D(e,a)}else await D(e,{})})(e),disabled:r[e.task_id],children:[r[e.task_id]?(0,d.jsx)("span",{className:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"}):(0,d.jsx)("i",{className:"bi bi-play-fill me-1"}),"Start"]})})}),(0,d.jsx)("td",{children:(0,d.jsxs)("div",{className:"btn-group btn-group-sm",role:"group",children:[(0,d.jsx)("input",{type:"radio",className:"btn-check",name:`mode-${e.task_id}`,id:`auto-${e.task_id}`,autoComplete:"off",checked:"auto"===e.mode,disabled:!!f[e.task_id],onChange:()=>w(e.task_id,{mode:"auto"})}),(0,d.jsx)("label",{className:"btn "+("auto"===e.mode?"btn-success":"btn-outline-secondary"),htmlFor:`auto-${e.task_id}`,onClick:()=>!f[e.task_id]&&w(e.task_id,{mode:"auto"}),style:{cursor:f[e.task_id]?"not-allowed":"pointer"},children:"Auto"}),(0,d.jsx)("input",{type:"radio",className:"btn-check",name:`mode-${e.task_id}`,id:`manual-${e.task_id}`,autoComplete:"off",checked:"manual"===e.mode,disabled:!!f[e.task_id],onChange:()=>w(e.task_id,{mode:"manual"})}),(0,d.jsx)("label",{className:"btn "+("manual"===e.mode?"btn-secondary":"btn-outline-secondary"),htmlFor:`manual-${e.task_id}`,onClick:()=>!f[e.task_id]&&w(e.task_id,{mode:"manual"}),style:{cursor:f[e.task_id]?"not-allowed":"pointer"},children:"Manual"}),f[e.task_id]&&(0,d.jsx)("div",{className:"spinner-border spinner-border-sm ms-2",role:"status","aria-hidden":"true"})]})}),(0,d.jsx)("td",{children:(0,d.jsxs)("div",{className:"d-flex flex-column gap-2",children:[(0,d.jsxs)("select",{className:"form-select form-select-sm",disabled:"auto"!==e.mode||!!f[e.task_id],value:e.repeat_interval||"none",onChange:a=>w(e.task_id,{repeat_interval:a.target.value,repeat_enabled:"none"!==a.target.value}),children:[(0,d.jsx)("option",{value:"none",children:"No Repeat"}),(0,d.jsx)("option",{value:"every_30_seconds",children:"Every 30 Seconds"}),(0,d.jsx)("option",{value:"every_minute",children:"Every Minute"}),(0,d.jsx)("option",{value:"every_5_minutes",children:"Every 5 Minutes"}),(0,d.jsx)("option",{value:"every_15_minutes",children:"Every 15 Minutes"}),(0,d.jsx)("option",{value:"every_30_minutes",children:"Every 30 Minutes"}),(0,d.jsx)("option",{value:"hourly",children:"Hourly"}),(0,d.jsx)("option",{value:"daily",children:"Daily"}),(0,d.jsx)("option",{value:"weekly",children:"Weekly"})]}),e.repeat_enabled&&"none"!==e.repeat_interval&&(0,d.jsxs)("span",{className:"badge bg-info text-dark small",children:[(0,d.jsx)("i",{className:"bi bi-arrow-repeat me-1"}),"Recurring"]})]})}),(0,d.jsx)("td",{children:"attendance_cache"===e.task_id?(0,d.jsxs)("div",{className:"row g-1",children:[(0,d.jsx)("div",{className:"col-6",children:(0,d.jsx)("input",{type:"date",className:"form-control form-control-sm",value:(null===(a=y[e.task_id])||void 0===a?void 0:a.startDate)||v.startDate,onChange:a=>g(s=>({...s,[e.task_id]:{...s[e.task_id],startDate:a.target.value}})),placeholder:"Start"})}),(0,d.jsx)("div",{className:"col-6",children:(0,d.jsx)("input",{type:"date",className:"form-control form-control-sm",value:(null===(s=y[e.task_id])||void 0===s?void 0:s.endDate)||v.endDate,onChange:a=>g(s=>({...s,[e.task_id]:{...s[e.task_id],endDate:a.target.value}})),placeholder:"End",max:(new Date).toISOString().split("T")[0]})})]}):(0,d.jsx)("span",{className:"text-muted small",children:"N/A"})}),(0,d.jsx)("td",{children:(0,d.jsxs)("div",{className:"row g-2 align-items-center",children:[(0,d.jsx)("div",{className:"col-6",children:(0,d.jsx)("input",{type:"date",className:"form-control form-control-sm",disabled:"auto"!==e.mode||!!f[e.task_id],value:e.schedule_date||"",onChange:a=>w(e.task_id,{schedule_date:a.target.value}),placeholder:e.repeat_enabled?"Start date":"Date"})}),(0,d.jsx)("div",{className:"col-6",children:(0,d.jsx)("input",{type:"time",className:"form-control form-control-sm",disabled:"auto"!==e.mode||!!f[e.task_id],value:e.schedule_time||"",onChange:a=>w(e.task_id,{schedule_time:a.target.value}),placeholder:e.repeat_enabled?"Start time":"Time"})})]})})]},e.task_id)})})]})})})}),x&&_&&(0,d.jsx)("div",{className:"modal show d-block",tabIndex:"-1",style:{backgroundColor:"rgba(0,0,0,0.5)"},children:(0,d.jsx)("div",{className:"modal-dialog modal-lg modal-dialog-centered",children:(0,d.jsxs)("div",{className:"modal-content",children:[(0,d.jsxs)("div",{className:"modal-header bg-primary text-white",children:[(0,d.jsxs)("h5",{className:"modal-title",children:[(0,d.jsx)("i",{className:"bi bi-check-circle me-2"}),_.taskName," - Results"]}),(0,d.jsx)("button",{type:"button",className:"btn-close btn-close-white",onClick:()=>p(!1)})]}),(0,d.jsx)("div",{className:"modal-body",children:function(e){const{data:a,taskId:s}=e;if(s.includes("_sync")){const e=a.data||{};return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"row mb-3",children:[(0,d.jsx)("div",{className:"col-md-3",children:(0,d.jsx)("div",{className:"card text-center border-primary",children:(0,d.jsxs)("div",{className:"card-body",children:[(0,d.jsx)("h3",{className:"text-primary mb-0",children:e.synced||e.total||0}),(0,d.jsx)("small",{className:"text-muted",children:"Total Synced"})]})})}),(0,d.jsx)("div",{className:"col-md-3",children:(0,d.jsx)("div",{className:"card text-center border-success",children:(0,d.jsxs)("div",{className:"card-body",children:[(0,d.jsx)("h3",{className:"text-success mb-0",children:e.created||0}),(0,d.jsx)("small",{className:"text-muted",children:"New Records"})]})})}),(0,d.jsx)("div",{className:"col-md-3",children:(0,d.jsx)("div",{className:"card text-center border-warning",children:(0,d.jsxs)("div",{className:"card-body",children:[(0,d.jsx)("h3",{className:"text-warning mb-0",children:e.updated||0}),(0,d.jsx)("small",{className:"text-muted",children:"Updated"})]})})}),(0,d.jsx)("div",{className:"col-md-3",children:(0,d.jsx)("div",{className:"card text-center border-danger",children:(0,d.jsxs)("div",{className:"card-body",children:[(0,d.jsx)("h3",{className:"text-danger mb-0",children:e.failed||0}),(0,d.jsx)("small",{className:"text-muted",children:"Failed"})]})})})]}),e.records&&e.records.length>0&&(0,d.jsxs)("div",{children:[(0,d.jsx)("h6",{className:"mb-3",children:"New Records:"}),(0,d.jsxs)("div",{className:"table-responsive",style:{maxHeight:"300px",overflowY:"auto"},children:[(0,d.jsxs)("table",{className:"table table-sm table-striped",children:[(0,d.jsx)("thead",{className:"sticky-top bg-light",children:(0,d.jsxs)("tr",{children:["divisions_sync"===s&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("th",{children:"Code"}),(0,d.jsx)("th",{children:"Name"})]}),"sections_sync"===s&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("th",{children:"Code"}),(0,d.jsx)("th",{children:"Name"}),(0,d.jsx)("th",{children:"Division"})]}),"employees_sync"===s&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("th",{children:"Emp No"}),(0,d.jsx)("th",{children:"Name"}),(0,d.jsx)("th",{children:"Division"}),(0,d.jsx)("th",{children:"Section"})]})]})}),(0,d.jsx)("tbody",{children:e.records.slice(0,50).map((e,a)=>(0,d.jsxs)("tr",{children:["divisions_sync"===s&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("td",{children:e.HIE_CODE||e.code}),(0,d.jsx)("td",{children:e.HIE_NAME||e.name})]}),"sections_sync"===s&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("td",{children:e.HIE_CODE||e.code}),(0,d.jsx)("td",{children:e.HIE_NAME||e.name}),(0,d.jsx)("td",{children:e.DIV_CODE||e.divisionCode})]}),"employees_sync"===s&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("td",{children:e.EMP_NO||e.empNo}),(0,d.jsx)("td",{children:e.EMP_NAME||e.name}),(0,d.jsx)("td",{children:e.DIV_NAME||e.division}),(0,d.jsx)("td",{children:e.SEC_NAME||e.section})]})]},a))})]}),e.records.length>50&&(0,d.jsxs)("p",{className:"text-muted text-center",children:["Showing first 50 of ",e.records.length," records"]})]})]})]})}if(s.includes("_cache")||"dashboard_sync"===s)return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"alert alert-success",children:[(0,d.jsx)("i",{className:"bi bi-check-circle me-2"}),(0,d.jsx)("strong",{children:"Success!"})," Cache operation completed successfully."]}),a.data&&(0,d.jsx)("div",{className:"bg-light p-3 rounded",children:(0,d.jsx)("pre",{className:"mb-0",style:{maxHeight:"300px",overflowY:"auto"},children:JSON.stringify(a.data,null,2)})}),a.message&&(0,d.jsx)("p",{className:"mt-3 mb-0",children:a.message})]});return(0,d.jsxs)("div",{children:[(0,d.jsxs)("div",{className:"alert alert-info",children:[(0,d.jsx)("i",{className:"bi bi-info-circle me-2"}),"Operation completed successfully"]}),a.message&&(0,d.jsx)("p",{children:a.message})]})}(_)}),(0,d.jsx)("div",{className:"modal-footer",children:(0,d.jsx)("button",{type:"button",className:"btn btn-secondary",onClick:()=>p(!1),children:"Close"})})]})})})]})}},83:(e,a,s)=>{s.d(a,{A:()=>l});s(43);var t=s(769),n=s(579);const l=e=>{let{title:a,subtitle:s,icon:l="bi-folder",actions:d,onBack:i}=e;return(0,n.jsxs)(n.Fragment,{children:[i&&(0,n.jsxs)("button",{className:"back-arrow-btn",onClick:i,title:"Back to Dashboard",style:{marginBottom:"12px",background:"transparent",color:"#0f172a",border:"1px solid rgba(15,23,42,0.08)",width:"auto",padding:"8px 12px"},children:[(0,n.jsx)("i",{className:"bi bi-arrow-left"}),"\xa0",(0,n.jsx)("span",{style:{fontWeight:600},children:"Back"})]}),(0,n.jsxs)("div",{className:"page-header-banner",children:[(0,n.jsxs)("div",{className:"page-header-content",children:[(0,n.jsxs)("div",{className:"page-header-left",children:[(0,n.jsx)("div",{className:"page-header-icon",children:(0,n.jsx)("i",{className:`bi ${l}`})}),(0,n.jsxs)("div",{className:"page-header-text",children:[(0,n.jsx)("h1",{children:a}),s&&(0,n.jsx)("p",{children:s})]})]}),(0,n.jsxs)("div",{className:"page-header-right",children:[d&&(0,n.jsx)("div",{className:"page-header-actions",children:d}),(0,n.jsx)("div",{className:"page-header-logo",children:(0,n.jsx)("img",{src:t,alt:"Company Logo"})})]})]}),(0,n.jsxs)("div",{className:"page-header-decoration",children:[(0,n.jsx)("div",{className:"decoration-circle decoration-circle-1"}),(0,n.jsx)("div",{className:"decoration-circle decoration-circle-2"}),(0,n.jsx)("div",{className:"decoration-circle decoration-circle-3"})]})]})]})}}}]);
//# sourceMappingURL=23.be5f34ba.chunk.js.map