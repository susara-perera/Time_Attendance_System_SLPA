const { sequelize } = require('../config/mysql');
const DivisionSync = require('../models/mysql/DivisionSync');
const SectionSync = require('../models/mysql/SectionSync');
const EmployeeSync = require('../models/mysql/EmployeeSync');
const SubSection = require('../models/SubSection');

/**
 * Service to update dashboard totals cache table for fast dashboard loading
 */

/**
 * Update total counts in dashboard cache table
 */
const updateDashboardTotals = async () => {
  try {
    console.log('üìä [DASHBOARD] Updating dashboard totals...');

    // Count from MySQL sync tables (fast indexed queries using raw SQL)
    const [[divisionsResult], [sectionsResult], [activeEmployeesResult]] = await Promise.all([
      sequelize.query('SELECT COUNT(*) as count FROM divisions_sync'),
      sequelize.query('SELECT COUNT(*) as count FROM sections_sync'),
      sequelize.query('SELECT COUNT(*) as count FROM employees_sync')
    ]);

    const divisionsCount = divisionsResult[0].count;
    const sectionsCount = sectionsResult[0].count;
    const activeEmployeesCount = activeEmployeesResult[0].count;

    // Count subsections from MongoDB (with connection check)
    let subsectionsCount = 0;
    try {
      const mongoose = require('mongoose');
      if (mongoose.connection.readyState === 1) {
        subsectionsCount = await SubSection.countDocuments();
      } else {
        console.warn('‚ö†Ô∏è [DASHBOARD] MongoDB not connected, skipping subsection count');
      }
    } catch (mongoErr) {
      console.warn('‚ö†Ô∏è [DASHBOARD] Failed to count subsections:', mongoErr.message);
    }

    // Update or insert the single row in total_count_dashboard
      // Compute today's absent employees for IS division (division id 66)
      let presentAbsentISJson = null;
      try {
        const today = require('moment')().format('YYYY-MM-DD');

        const empSql = `
          SELECT e.EMP_NO as empNo, e.EMP_NAME as name
          FROM employees_sync e
          WHERE e.IS_ACTIVE = 1
          AND (e.DIV_CODE COLLATE utf8mb4_unicode_ci = :divId OR e.DIV_CODE COLLATE utf8mb4_unicode_ci IN (SELECT HIE_CODE COLLATE utf8mb4_unicode_ci FROM divisions_sync WHERE id = :divId))
      `;

      const presentSql = `
        SELECT DISTINCT a.employee_id as empNo
        FROM attendance_sync a
        JOIN employees_sync e ON a.employee_id = e.EMP_NO
        WHERE a.attendance_date = :today AND a.status = 'present'
          AND (e.DIV_CODE COLLATE utf8mb4_unicode_ci = :divId OR e.DIV_CODE COLLATE utf8mb4_unicode_ci IN (SELECT HIE_CODE COLLATE utf8mb4_unicode_ci FROM divisions_sync WHERE id = :divId))
          sequelize.query(presentSql, { replacements: { today, divId: 66 } })
        ]);

        const empRows = Array.isArray(empRes) ? empRes[0] : [];
        const presentRows = Array.isArray(presentRes) ? presentRes[0] : [];

        const employeesIS = empRows.map(r => ({ empNo: String(r.empNo), name: r.name }));
        const presentSet = new Set((presentRows || []).map(r => String(r.empNo)));

        const absentArr = employeesIS.filter(emp => !presentSet.has(String(emp.empNo)));

        // store full list (ids and names) in JSON string (can be NULL if empty)
        if (absentArr && absentArr.length > 0) {
          presentAbsentISJson = JSON.stringify(absentArr);
        }
      } catch (err) {
        console.warn('‚ö†Ô∏è [DASHBOARD] Failed to compute present_absent_IS:', err.message);
        presentAbsentISJson = null;
      }

      const sql = "INSERT INTO total_count_dashboard (id, totalDivisions, totalSections, totalSubsections, totalActiveEmployees, totalInactiveEmployees, present_absent_IS) " +
        "VALUES (1, :divisions, :sections, :subsections, :activeEmployees, 0, :presentAbsent) " +
        "ON DUPLICATE KEY UPDATE " +
        "totalDivisions = :divisions, " +
        "totalSections = :sections, " +
        "totalSubsections = :subsections, " +
        "totalActiveEmployees = :activeEmployees, " +
        "totalInactiveEmployees = 0, " +
        "present_absent_IS = :presentAbsent, " +
        "last_updated = CURRENT_TIMESTAMP";

      await sequelize.query(sql, {
        replacements: {
          divisions: divisionsCount,
          sections: sectionsCount,
          subsections: subsectionsCount,
          activeEmployees: activeEmployeesCount,
          presentAbsent: presentAbsentISJson
        }
      });

    console.log('‚úÖ [DASHBOARD] Dashboard totals updated successfully');
    console.log('   Divisions: ' + divisionsCount + ', Sections: ' + sectionsCount + ', SubSections: ' + subsectionsCount + ', Active Employees: ' + activeEmployeesCount);

    return {
      success: true,
      totals: {
        totalDivisions: divisionsCount,
        totalSections: sectionsCount,
        totalSubsections: subsectionsCount,
        totalActiveEmployees: activeEmployeesCount,
        totalInactiveEmployees: 0
      }
    };

  } catch (error) {
    console.error('‚ùå [DASHBOARD] Failed to update dashboard totals:', error.message);
    throw error;
  }
};

/**
 * Get cached dashboard totals (very fast query - single row)
 */
const getDashboardTotals = async () => {
  try {
    const [results] = await sequelize.query(
      "SELECT " +
      "totalDivisions, " +
      "totalSections, " +
      "totalSubsections, " +
      "totalActiveEmployees, " +
      "totalInactiveEmployees, " +
      "present_absent_IS, " +
      "last_updated " +
      "FROM total_count_dashboard " +
      "WHERE id = 1 " +
      "LIMIT 1"
    );

    if (results && results.length > 0) {
      return {
        success: true,
        data: results[0],
        cached: true
      };
    }

    // If no data, return zeros
    return {
      success: true,
      data: {
        totalDivisions: 0,
        totalSections: 0,
        totalSubsections: 0,
        totalActiveEmployees: 0,
        totalInactiveEmployees: 0,
        present_absent_IS: null,
        last_updated: null
      },
      cached: false
    };

  } catch (error) {
    console.error('‚ùå [DASHBOARD] Failed to get dashboard totals:', error.message);
    throw error;
  }
};

/**
 * Initialize dashboard totals table (create and populate)
 */
const initializeDashboardTotals = async () => {
  try {
    const fs = require('fs');
    const path = require('path');

    // Create table if not exists
    const sqlPath = path.join(__dirname, '..', 'config', 'createDashboardTable.sql');
    const sql = fs.readFileSync(sqlPath, 'utf8');
    await sequelize.query(sql);

    console.log('‚úÖ [DASHBOARD] Dashboard totals table initialized');

    // Update counts
    await updateDashboardTotals();

  } catch (error) {
    console.error('‚ùå [DASHBOARD] Failed to initialize dashboard totals:', error.message);
    throw error;
  }
};

module.exports = {
  updateDashboardTotals,
  getDashboardTotals,
  initializeDashboardTotals
};
